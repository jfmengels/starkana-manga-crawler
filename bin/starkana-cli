#!/usr/bin/env node

'use strict';

var fs = require("fs");
var async = require("async");
var extend = require('extend');
var program = require('commander');

var utils = require("../utils"),
    starkana = require("../index"),
    crawler = starkana.crawler,
    cleaner = starkana.cleaner,
    renamer = starkana.renamer,
    updater = starkana.updater,
    subscriber = starkana.subscriber;


var allowedOutputFormats = ["folder", "zip"],
    configFile = "./config.json",
    configKeys = [];

function gracefulEnd(error) {
    if (error) {
        console.error("\n  error: " + error + "\n");
        process.exit(1);
    }
    process.exit(0);
}

function saveConfig(config) {
    fs.writeFileSync(configFile, JSON.stringify(utils.pick(config, configKeys), null, 4));
}

function init(program, options) {
    var config = {},
        baseConfig = {
            readDirectories: [],
            outputDirectory: ".",
            outputFormat: "folder",
            cleanStarkanaCredits: true,
            cleanDuplicates: false,
            rename: true,
            subscriptions: []
        };

    configKeys = Object.keys(baseConfig);
    configFile = program.config || configFile;

    try {
        var configData = fs.readFileSync();
        config = JSON.parse(configData);
    } catch (e) {}

    config = extend(baseConfig, config, options);

    if (allowedOutputFormats.indexOf(config.outputFormat) === -1) {
        gracefulEnd("unsupported outputFormat: " + config.outputFormat);
    }

    // Save config to file
    if (program.save) {
        saveConfig(config);
    }
    return config;
}

function progressPrinter(progress) {
    console.log(progress.type + "\t" + progress.action + "\t" + progress.series + " " + (progress.chapter || ""));
}

function asyncJobRunner(config) {
    return function(job, cb) {
        crawler.runJob(config, job, cb, progressPrinter);
    };
}

function detailCleanOperation(job, data) {
    var output = [];
    if (data.creditsRemoved === 0 && data.duplicatesRemoved === 0) {
        return console.log("Nothing to clean.");
    }
    if (job.cleanStarkanaCredits) {
        output.push(data.creditsRemoved + ' credit');
    }
    if (job.cleanDuplicates) {
        output.push(data.duplicatesRemoved + ' duplicate');
    }
    console.log('Removed ' + output.join(' and ') + ' files.');
}

function examples(exampleArray) {
    var commandName = program._name;
    console.log('  Examples:');
    console.log();
    exampleArray.forEach(function(example) {
        console.log('    $ ' + commandName + ' ' + example);
    });
    console.log();
}

function rename(folders, config, cb) {
    renamer.renameFolders(folders, config, cb);
}


program
    .version('1.0.0')
    .option("--config <config>", "Set configuration file to use.")
    .option('-S, --save', 'Save settings to the default config file so that they will automatically be reused on the next call.');

var downloadCommand = program
    .command('download <series> <chapters> [maxChapter]')
    .alias('dl')
    .description('Downloads specific chapters from a given series.')
    .option('-l, --untilLast', 'Download until the last released chapter')
    .option('-f, --outputFormat <outputFormat>', 'Set how the downloaded content will be outputted: ' + allowedOutputFormats.join(' | ') + '.')
    .option('-u, --url <url>', 'Use url path instead of normal one. Should not contain shared path "starkana.com/manga".')
    .action(function(series, chapters, maxChapter, options) {
        if (!series) {
            gracefulEnd("Missing series argument.");
        }
        if (!chapters) {
            gracefulEnd("Missing chapters argument.");
        }
        var config = init(program, options),
            jobs = [
                crawler.createJob({
                    series: series,
                    chapter: parseFloat(chapters),
                    maxChapter: parseFloat(maxChapter),
                    untilLast: config.untilLast,
                    url: config.url
                })
            ];

        async.eachLimit(jobs, 5, asyncJobRunner(config), gracefulEnd);

    }).on('--help', function() {
        examples([
            'download "One Piece" 42',
            'dl Naruto 690'
        ]);
    });

var updateCommand = program
    .command('update [series...]')
    .alias('up')
    .description('Update the series you subscribed to.')
    .option('-r, --readDirectories <directories>', 'Directories in which to look into to find current progress (not including the outputDirectory). Separate by \';\'.')
    .option('-f, --force', 'When no chapters are found for a series, nothing will get downloaded unless forced.')
    .action(function(series, options) {
        if (options.readDirectories) {
            options.readDirectories = options.readDirectories.split(';');
        }
        var config = init(program, options);
        updater.update(series, config, gracefulEnd, progressPrinter);
    }).on('--help', function() {
        examples([
            'update',
            'up Bleach "One Piece" -r /look/in/this/folder;/and/in/this/one'
        ]);
    });

var cleanCommand = program
    .command('clean <folders...>')
    .alias('cl')
    .description('Clean by removing starkana and/or duplicate files in a folder.')
    .action(function(folders, options) {
        if (!folders || folders.length === 0) {
            gracefulEnd("Missing folder argument.");
        }

        if (!options.cleanStarkanaCredits && !options.cleanDuplicates) {
            gracefulEnd("Missing argument specifying the cleaning operation (-s / -d).");
        }

        var job = {
            cleanStarkanaCredits: options.cleanStarkanaCredits || false,
            cleanDuplicates: options.cleanDuplicates || false
        };

        cleaner.cleanFolders(folders, job, function(error, data) {
            if (error) {
                return gracefulEnd(error);
            }
            detailCleanOperation(job, data);

            var config = init(program, options);
            if (config.rename) {
                rename(folders, config, gracefulEnd);
            }
        });
    }).on('--help', function() {
        examples([
            'clean /my/folder -sd',
            'cl /my/folder /my/second/folder -sd'
        ]);
    });

var renameCommand = program
    .command('rename <folders...>')
    .alias('rn')
    .description('Rename files in folders.')
    .action(function(folders, options) {
        if (!folders || folders.length === 0) {
            gracefulEnd("Missing folder argument.");
        }
        var config = init(program, options);
        rename(folders, config, gracefulEnd);
    }).on('--help', function() {
        examples([
            'rename /my/folder',
            'rn /my/folder /my/second/folder'
        ]);
    });

program
    .command('sub [series...]')
    .description('List subscriptions or subscribe to series.')
    .option('-d, --delete', 'Unsubscribe from series.')
    .option('-u, --url <url>', 'Specify url for the given series (can only be used for one series).')
    .action(function(series, options) {
        var config = init(program, options),
            action;

        if (options.delete && series.length === 0) {
            gracefulEnd("Missing series argument.");
        }

        if (series.length === 0) { // Listing subscriptions
            var subscriptions = config.subscriptions.map(function(s) {
                if (s.url) {
                    return s.name + " (at " + s.url + ")";
                }
                return s.name;
            })
            console.log(subscriptions.sort().join('\n'));
            return;
        }

        if (config.delete) { // Unsubscribing
            subscriber.unsubscribe(series, config);
            action = "Unsubscribed from";
        } else { // Subscribing
            subscriber.subscribe(series, config, options.url);
            config.subscriptions = config.subscriptions.sort(function(a, b) {
                if (a.name < b.name) {
                    return -1;
                }
                if (a.name > b.name) {
                    return 1;
                }
                return 0;
            })
            action = "Subscribed to";
        }
        saveConfig(config);
        console.log(action + " " + series.join(", ") + ".");
        gracefulEnd();
    }).on('--help', function() {
        examples([
            'sub                        # Lists subscriptions',
            'sub Naruto "One Piece"     # Subscribe to Naruto and One Piece',
            'sub -d Naruto              # Unsubscribe from Naruto',
            'sub Naruto -u N/Naruto     # Subscribe to Naruto, and use N/Naruto as the url'
        ]);
    });

// Adding options common to multiple commands
[downloadCommand, updateCommand, cleanCommand].forEach(function(command) {
    command
        .option('-s, --cleanStarkanaCredits', 'Remove Starkana credits')
        .option('-d, --cleanDuplicates', 'Remove duplicate files in all of the downloaded chapters (used to remove scanlation credits).')
        .option('-R, --rename', 'Rename folders after operation.');
});

[downloadCommand, updateCommand].forEach(function(command) {
    command
        .option('-O, --outputDirectory <directory>', 'Directory in which the files will be downloaded.');
});

program.parse(process.argv);

if (!program.args.length) {
    program.help();
}